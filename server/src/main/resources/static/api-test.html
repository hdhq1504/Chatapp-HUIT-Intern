<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>API Test - Chat App</title>
        <style>
            body {
                font-family: system-ui, Arial, sans-serif;
                margin: 0;
                background: #0f172a;
                color: #e2e8f0;
            }
            header {
                padding: 16px;
                background: #111827;
                border-bottom: 1px solid #1f2937;
            }
            main {
                display: grid;
                grid-template-columns: 320px 1fr;
                gap: 16px;
                padding: 16px;
            }
            .card {
                background: #111827;
                border: 1px solid #1f2937;
                border-radius: 10px;
                padding: 12px;
            }
            input,
            select,
            textarea {
                width: 100%;
                padding: 10px;
                border-radius: 8px;
                border: 1px solid #374151;
                background: #0b1221;
                color: #e2e8f0;
            }
            button {
                background: #2563eb;
                color: white;
                border: none;
                padding: 10px 12px;
                border-radius: 8px;
                cursor: pointer;
            }
            button:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }
            .row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            .actions {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }
            .log {
                height: 320px;
                overflow: auto;
                background: #0b1221;
                padding: 8px;
                border-radius: 8px;
                font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
                font-size: 12px;
            }
            .muted {
                color: #9ca3af;
            }
            .ok {
                color: #34d399;
            }
            .err {
                color: #f87171;
            }
        </style>
        }
    </head>
    <body>
        <header>
            <strong>API Test</strong>
            <span id="userInfo" class="muted" style="margin-left: 8px"></span>
        </header>
        <main>
            <section class="card">
                <h3>Đăng nhập</h3>
                <div class="row">
                    <div>
                        <label>Email</label>
                        <input id="email" placeholder="email" />
                    </div>
                    <div>
                        <label>Mật khẩu</label>
                        <input id="password" placeholder="password" type="password" />
                    </div>
                </div>
                <div class="actions" style="margin-top: 8px">
                    <button id="btnLogin">Login</button>
                    <button id="btnLogout" disabled>Logout</button>
                </div>
                <div style="margin-top: 8px">
                    <label>Access Token</label>
                    <textarea id="token" rows="3" readonly></textarea>
                </div>
            </section>

            <section class="card">
                <h3>Gọi API</h3>
                <div class="actions">
                    <button id="btnMeRooms" disabled>GET /users/me/rooms</button>
                    <button id="btnUsersSearch" disabled>Tìm user</button>
                    <button id="btnCreateRoom" disabled>POST /rooms</button>
                    <button id="btnGetRoomMessages" disabled>GET /rooms/{id}/messages</button>
                    <button id="btnSendRoomMessage" disabled>POST /rooms/{id}/messages</button>
                </div>
                <div style="margin-top: 10px" class="row">
                    <div>
                        <label>Room ID</label>
                        <input id="roomId" placeholder="room UUID" />
                    </div>
                    <div>
                        <label>Search query</label>
                        <input id="query" placeholder="name/email/phone" />
                    </div>
                </div>
                <div style="margin-top: 10px" class="row">
                    <div>
                        <label>Members (create room) - CSV userIds</label>
                        <input id="memberIds" placeholder="uuid1,uuid2" />
                    </div>
                    <div>
                        <label>Message content</label>
                        <input id="messageContent" placeholder="Hello" />
                    </div>
                </div>
                <div style="margin-top: 10px">
                    <label>Kết quả</label>
                    <pre id="output" class="log"></pre>
                </div>
            </section>
        </main>

        <script>
            const base = '';
            const $ = (id) => document.getElementById(id);
            const out = $('output');
            const userInfo = $('userInfo');

            const log = (msg, cls = '') => {
                const time = new Date().toISOString();
                out.innerHTML = `[${time}] ${msg}\n` + out.innerHTML;
            };

            const setAuthState = (token, user) => {
                const has = !!token;
                $('btnLogout').disabled = !has;
                $('btnMeRooms').disabled = !has;
                $('btnUsersSearch').disabled = !has;
                $('btnCreateRoom').disabled = !has;
                $('btnGetRoomMessages').disabled = !has;
                $('btnSendRoomMessage').disabled = !has;
                $('btnLogin').disabled = has;
                $('token').value = token || '';
                userInfo.textContent = has ? `Đã đăng nhập: ${user?.email || ''}` : '';
            };

            const authHeader = () => ({ Authorization: 'Bearer ' + (localStorage.getItem('accessToken') || '') });

            $('btnLogin').onclick = async () => {
                try {
                    const body = { email: $('email').value, password: $('password').value };
                    const res = await fetch(base + '/api/v1/auth/signin', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body),
                    });
                    const json = await res.json();
                    if (!res.ok) throw new Error(json.message || 'Login failed');
                    const token = json.data?.accessToken;
                    const user = json.data?.user;
                    localStorage.setItem('accessToken', token);
                    localStorage.setItem('currentUser', JSON.stringify(user || {}));
                    setAuthState(token, user);
                    log('✅ Login OK');
                } catch (e) {
                    log('❌ Login: ' + e.message);
                }
            };

            $('btnLogout').onclick = async () => {
                try {
                    const res = await fetch(base + '/api/v1/auth/logout', {
                        method: 'POST',
                        headers: { ...authHeader() },
                    });
                    const json = await res.json();
                    if (!res.ok) throw new Error(json.message || 'Logout failed');
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('currentUser');
                    setAuthState('', null);
                    log('✅ Logout OK');
                } catch (e) {
                    log('❌ Logout: ' + e.message);
                }
            };

            $('btnMeRooms').onclick = async () => {
                try {
                    const res = await fetch(base + '/api/v1/users/me/rooms', { headers: { ...authHeader() } });
                    const json = await res.json();
                    log('GET me/rooms -> ' + JSON.stringify(json, null, 2));
                } catch (e) {
                    log('❌ me/rooms: ' + e.message);
                }
            };

            $('btnUsersSearch').onclick = async () => {
                try {
                    const q = encodeURIComponent($('query').value || '');
                    const res = await fetch(base + `/api/v1/users/search?query=${q}`, { headers: { ...authHeader() } });
                    const json = await res.json();
                    log('GET users/search -> ' + JSON.stringify(json, null, 2));
                } catch (e) {
                    log('❌ users/search: ' + e.message);
                }
            };

            $('btnCreateRoom').onclick = async () => {
                try {
                    const members = ($('memberIds').value || '')
                        .split(',')
                        .map((s) => s.trim())
                        .filter(Boolean);
                    const body = { members };
                    const res = await fetch(base + '/api/v1/rooms', {
                        method: 'POST',
                        headers: { ...authHeader(), 'Content-Type': 'application/json' },
                        body: JSON.stringify(body),
                    });
                    const json = await res.json();
                    log('POST /rooms -> ' + JSON.stringify(json, null, 2));
                    if (json?.data?.createdAt) $('roomId').value = json?.data?.id || $('roomId').value;
                } catch (e) {
                    log('❌ create room: ' + e.message);
                }
            };

            $('btnGetRoomMessages').onclick = async () => {
                try {
                    const roomId = $('roomId').value.trim();
                    const res = await fetch(base + `/api/v1/rooms/${roomId}/messages?limit=20`, {
                        headers: { ...authHeader() },
                    });
                    const json = await res.json();
                    log('GET /rooms/{id}/messages -> ' + JSON.stringify(json, null, 2));
                } catch (e) {
                    log('❌ room messages: ' + e.message);
                }
            };

            $('btnSendRoomMessage').onclick = async () => {
                try {
                    const roomId = $('roomId').value.trim();
                    const body = { content: $('messageContent').value };
                    const res = await fetch(base + `/api/v1/rooms/${roomId}/messages`, {
                        method: 'POST',
                        headers: { ...authHeader(), 'Content-Type': 'application/json' },
                        body: JSON.stringify(body),
                    });
                    const json = await res.json();
                    log('POST /rooms/{id}/messages -> ' + JSON.stringify(json, null, 2));
                } catch (e) {
                    log('❌ send room message: ' + e.message);
                }
            };

            // init
            (function init() {
                const token = localStorage.getItem('accessToken') || '';
                const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
                setAuthState(token, user);
            })();
        </script>
    </body>
</html>
